<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>新進館藏</title>
<style>
  :root{
    --fg:#1f2937;
    --muted:#6b7280;
    --link:#0b57d0;
    --line:#e5e7eb;
    --accent:#2563eb;
  }
  html,body{margin:0;padding:0;background:#fff;color:var(--fg);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  h1{font-size:28px;margin:0 0 18px}
  /* 工具列在右側，同列不換行 */
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:nowrap;margin:0 0 10px;white-space:nowrap}
  .toolbar select,.toolbar input{padding:8px 10px;border:1px solid var(--line);border-radius:10px;font-size:15px}
  .toolbar label{color:var(--muted);font-size:14px}
  .result-hint{color:var(--muted);font-size:14px;margin:0 10px 8px 0}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:12px 10px;vertical-align:top}
  th{background:#fafafa;font-weight:700;font-size:15px;text-align:left}
  td a{color:var(--link);text-decoration:none}
  td a:hover{text-decoration:underline}
  /* 題名較寬可自動換行 */
  .col-title{width:55%}
  .col-loc{width:18%}
  .col-call{width:17%}
  .col-date{width:10%}
  /* 分頁：純數字，不要方框；單行不換 */
  .pager{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin:16px 0 8px;white-space:nowrap}
  .pager a,.pager span{font-size:16px;color:var(--fg);text-decoration:none}
  .pager a:hover{color:var(--accent);text-decoration:underline}
  .pager .current{color:var(--accent);font-weight:700;text-decoration:underline}
  .muted{color:var(--muted)}
  @media (max-width:900px){
    .col-title{width:52%}
    .col-loc{width:20%}.col-call{width:18%}.col-date{width:10%}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>新進館藏</h1>

  <div class="toolbar">
    <span class="result-hint" id="hint">顯示第 1 至 20 項結果，共 0 項</span>
    <label>顯示
      <select id="pageSize">
        <option>10</option><option selected>20</option><option>50</option>
      </select> 項
    </label>
    <input id="q" placeholder="搜尋：題名／索書號" />
    <select id="loc">
      <option value="">全部館藏地</option>
    </select>
  </div>

  <div class="pager" id="pagerTop"></div>

  <table>
    <thead>
      <tr>
        <th class="col-title">題名</th>
        <th class="col-loc">館藏地</th>
        <th class="col-call">索書號</th>
        <th class="col-date">上架日期</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="pager" id="pagerBottom"></div>
</div>

<script>
/*** === 1) 資料來源（請按需替換你的 n8n Webhook URL） === ***/
const API = 'https://sculib.app.n8n.cloud/webhook/sculibnewbooks';

/*** === 2) 館藏地英轉中（依你提供的對照） === ***/
const LOC_MAP = {
  "NBMAINLIBRARY": "雙溪中正非書",
  "NBDOWNTOWNCAMPUS": "城區分館非書",
  "REFDOWNTOWNCAMPUS": "雙溪中正參考",
  "REFMAINLIBRARY": "城區分館參考",
  "STACKSMAINLIBRARY": "雙溪中正書庫",
  "STACKSDOWNTOWNCAMPUS": "城區分館書庫",
  "SEMINARROOMMAINLIBRARY": "雙溪中正研討室",
  "SEMINARROOMDOWNTOWNCAMPUS": "城區分館研討室"
};

/*** === 3) 狀態 & DOM === ***/
let RAW = []; // 來自 API 的 rows（已處理）
const state = { page:1, size:20, q:"", loc:"" };

const qEl = document.getElementById('q');
const sizeEl = document.getElementById('pageSize');
const locEl = document.getElementById('loc');
const tbody = document.getElementById('tbody');
const hint = document.getElementById('hint');
const pagerTop = document.getElementById('pagerTop');
const pagerBottom = document.getElementById('pagerBottom');

/*** === 4) 載入資料 === ***/
async function load(){
  try{
    const r = await fetch(API, { cache:'no-store' });
    const d = await r.json();
    const rows = Array.isArray(d.rows) ? d.rows : [];

    // 正規化：把 undefined 改空字串、館藏地英轉中、日期整理
    RAW = rows.map((x,i) => {
      const loc = LOC_MAP[(x.location||'').trim()] || (x.location||'');
      // Column8 日期：允許 yyyy-mm-dd 或 yyyymmdd，都整理成 yyyy-mm-dd
      let date = (x.date||'').trim();
      if (/^\d{8}$/.test(date)) date = `${date.slice(0,4)}-${date.slice(4,6)}-${date.slice(6)}`;
      return {
        idx: i+1,
        title: (x.title||'').trim(),
        location: loc,
        callno: (x.callno||'').trim(),
        date: date
      };
    });

    fillLocations();
    render();
  }catch(e){
    alert('載入新進館藏失敗：' + e.message);
    RAW = [];
    fillLocations();
    render();
  }
}

/*** === 5) 館藏地下拉 === ***/
function fillLocations(){
  const opts = [''].concat(
    [...new Set(RAW.map(r=>r.location).filter(Boolean))].sort()
  );
  locEl.innerHTML = '<option value="">全部館藏地</option>' +
    opts.filter(v=>v).map(v=>`<option>${v}</option>`).join('');
}

/*** === 6) 篩選 + 分頁 === ***/
function applyFilter(){
  const q = state.q.toLowerCase();
  return RAW.filter(r=>{
    if (state.loc && r.location !== state.loc) return false;
    if (!q) return true;
    return (r.title + ' ' + r.callno).toLowerCase().includes(q);
  });
}

function formatDate(s){
  return s || '';
}

/*** === 7) 分頁元件：純數字，不加框，單行顯示 === ***/
function buildPager(total, pages, page, onPage){
  const els = [];

  const btn = (label, p, disabled=false, current=false) => {
    if (disabled) return `<span class="muted">${label}</span>`;
    if (current) return `<span class="current">${label}</span>`;
    return `<a href="#" data-p="${p}">${label}</a>`;
  };

  // 上一頁
  els.push(btn('上一頁', page-1, page<=1, false));

  // 數字：1 ~ 5，然後 …，最後一頁（或 35 依需求）
  const window = 5;
  const showLast = Math.min(pages, 35); // 依你畫面示意保留到 35

  for (let i=1;i<=Math.min(showLast, window);i++){
    els.push(btn(String(i), i, false, i===page));
  }
  if (showLast > window){
    els.push('<span>…</span>');
    els.push(btn(String(showLast), showLast, false, page===showLast));
  }

  // 下一頁
  els.push(btn('下一頁', page+1, page>=pages, false));

  const html = els.join(' ');
  const wrap = `<div class="pager-line">${html}</div>`;
  return wrap;
}

function wirePager(el){
  el.addEventListener('click', e=>{
    const a = e.target.closest('a[data-p]');
    if (!a) return;
    e.preventDefault();
    const p = Number(a.dataset.p);
    const total = applyFilter().length;
    const pages = Math.max(1, Math.ceil(total/state.size));
    if (p>=1 && p<=pages){
      state.page = p;
      render();
    }
  });
}

/*** === 8) 渲染 === ***/
function render(){
  const rows = applyFilter();
  const total = rows.length;
  const pages = Math.max(1, Math.ceil(total/state.size));
  if (state.page > pages) state.page = pages;

  const start = (state.page-1)*state.size;
  const pageRows = rows.slice(start, start+state.size);

  hint.textContent = `顯示第 ${total? (start+1) : 0} 至 ${start+pageRows.length} 項結果，共 ${total} 項`;

  tbody.innerHTML = pageRows.map(r=>`
    <tr>
      <td class="col-title"><a href="#" title="${r.title}">${r.title||'(無題名)'}</a></td>
      <td class="col-loc">${r.location||''}</td>
      <td class="col-call">${r.callno||''}</td>
      <td class="col-date">${formatDate(r.date)}</td>
    </tr>
  `).join('') || `<tr><td colspan="4" class="muted">目前沒有資料</td></tr>`;

  // 分頁（上下各一組）
  const pagerHTML = buildPager(total, pages, state.page, p=>{ state.page=p; render(); });
  pagerTop.innerHTML = pagerHTML;
  pagerBottom.innerHTML = pagerHTML;

  // 綁定點擊
  wirePager(pagerTop);
  wirePager(pagerBottom);
}

/*** === 9) 事件 === ***/
qEl.addEventListener('input', ()=>{ state.q = qEl.value.trim(); state.page=1; render(); });
sizeEl.addEventListener('change', ()=>{ state.size = Number(sizeEl.value)||20; state.page=1; render(); });
locEl.addEventListener('change', ()=>{ state.loc = locEl.value; state.page=1; render(); });

/*** === 10) 啟動 === ***/
load();
</script>
</body>
</html>
