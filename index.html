<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>新進館藏</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:24px}
  h1{font-size:20px;margin:0 0 12px}

  /* 工具列靠右 */
  .toolbar{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin:0 0 8px;flex-wrap:wrap}
  .toolbar input,.toolbar select{padding:8px;border:1px solid #ddd;border-radius:8px}

  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eee;padding:8px 8px;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0;z-index:1}

  /* 題名單行省略、更緊湊 */
  .title{line-height:1.2}
  .title a{
    color:#0b57d0;text-decoration:none;font-size:14px;
    display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    max-width:100%;
  }
  .title a:hover{text-decoration:underline}
  .meta{color:#666;font-size:12px;margin-top:2px}

  /* 分頁控制（上下各一組） */
  .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:8px 0}
  .pager button{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .pager button[disabled]{opacity:.4;cursor:not-allowed}

  @media(max-width:720px){
    th:nth-child(3),td:nth-child(3){display:none} /* 手機隱藏索書號 */
  }
</style>
</head>
<body>
<h1>新進館藏</h1>

<!-- 上方工具列（靠右） -->
<div class="toolbar">
  <label>每頁
    <select id="pageSize"><option>10</option><option>20</option><option>50</option></select> 筆
  </label>
  <input id="q" placeholder="關鍵字搜尋（題名／索書號／上架日期）"/>
  <select id="loc"><option value="">全部館藏地</option></select>
</div>

<!-- 上方分頁 -->
<div class="pager">
  <button id="prevTop">上一頁</button>
  <span id="infoTop"></span>
  <button id="nextTop">下一頁</button>
</div>

<table id="tbl">
  <thead>
    <tr>
      <th>題名</th>
      <th style="width:180px;">館藏地</th>
      <th style="width:160px;">索書號</th>
      <th style="width:120px;">上架日期</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- 下方分頁 -->
<div class="pager">
  <button id="prevBot">上一頁</button>
  <span id="infoBot"></span>
  <button id="nextBot">下一頁</button>
</div>

<script>
const API = 'https://sculib.app.n8n.cloud/webhook/sculibnewbooks';
let RAW = [];
const state = { page:1, size:10, q:"", loc:"" };

const qEl = document.getElementById('q');
const sizeEl = document.getElementById('pageSize');
const locEl = document.getElementById('loc');
const tbody = document.querySelector('#tbl tbody');

const prevTop = document.getElementById('prevTop');
const nextTop = document.getElementById('nextTop');
const infoTop = document.getElementById('infoTop');

const prevBot = document.getElementById('prevBot');
const nextBot = document.getElementById('nextBot');
const infoBot = document.getElementById('infoBot');

async function load(){
  try{
    const r = await fetch(API, { cache:'no-store' });
    const d = await r.json();
    RAW = Array.isArray(d.rows) ? d.rows : [];
  }catch(e){
    alert('載入新進館藏失敗：' + e.message);
    RAW = [];
  }
  fillLocations();
  render();
}

function fillLocations(){
  const set = new Set(RAW.map(x => x.location).filter(Boolean));
  locEl.innerHTML = '<option value="">全部館藏地</option>' + [...set].map(v => `<option>${v}</option>`).join('');
}

function applyFilter(){
  const q = state.q.trim().toLowerCase();
  return RAW.filter(r=>{
    if(state.loc && r.location!==state.loc) return false;
    if(!q) return true;
    const hay = (r.title+' '+r.callno+' '+r.authorYear).toLowerCase();
    return hay.includes(q);
  });
}

function render(){
  const rows = applyFilter();
  const total = rows.length;
  const pages = Math.max(1, Math.ceil(total/state.size));
  if(state.page>pages) state.page=pages;
  const start = (state.page-1)*state.size;
  const pageRows = rows.slice(start, start+state.size);

  tbody.innerHTML = pageRows.map(r=>`
    <tr>
      <td class="title">
        <a href="${r.link}" target="_blank" rel="noopener">${escapeHtml(r.title)}</a>
      </td>
      <td>${escapeHtml(r.location||'')}</td>
      <td>${escapeHtml(r.callno||'')}</td>
      <td>${escapeHtml(r.authorYear||'')}</td>
    </tr>
  `).join('');

  const infoText = total? `第 ${start+1}-${Math.min(start+state.size,total)} 筆，共 ${total} 筆` : '目前沒有資料';
  infoTop.textContent = infoText;
  infoBot.textContent = infoText;

  prevTop.disabled = prevBot.disabled = state.page<=1;
  nextTop.disabled = nextBot.disabled = state.page>=pages;
}

function escapeHtml(s){return (s??'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))}

// 事件
qEl.addEventListener('input', ()=>{ state.q=qEl.value; state.page=1; render(); });
sizeEl.addEventListener('change', ()=>{ state.size=+sizeEl.value||10; state.page=1; render(); });
locEl.addEventListener('change', ()=>{ state.loc=locEl.value; state.page=1; render(); });

prevTop.addEventListener('click', ()=>{ if(state.page>1){ state.page--; render(); }});
nextTop.addEventListener('click', ()=>{ state.page++; render(); });
prevBot.addEventListener('click', ()=>{ if(state.page>1){ state.page--; render(); }});
nextBot.addEventListener('click', ()=>{ state.page++; render(); });

load();
</script>
</body>
</html>
