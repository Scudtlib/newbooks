<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>新進館藏</title>
<style>
  :root{--fg:#1f2937;--muted:#6b7280;--blue:#2563eb;--line:#e5e7eb;--bg:#fafafa;--maxw:1180px;--radius:12px}
  *{box-sizing:border-box}html,body{margin:0}
  body{font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bg)}
  .wrap{max-width:var(--maxw);margin:auto;padding:20px}
  h1{margin:10px 0 14px;font-size:26px;font-weight:700}
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-start;margin:6px 0 14px}
  .stat{color:var(--muted);font-size:13px;margin-right:auto}
  select,input[type="text"]{height:32px;border:1px solid var(--line);border-radius:8px;padding:0 8px;background:#fff}
  input[type="checkbox"]{transform:translateY(1px)}
  .table{background:#fff;border:1px solid var(--line);border-radius:var(--radius);overflow:hidden}
  table{width:100%;border-collapse:collapse}
  thead th{background:#f8fafc;color:#374151;font-weight:600;font-size:14px}
  th,td{padding:12px 14px;border-bottom:1px solid var(--line);vertical-align:top}
  td.nowrap{white-space:nowrap}
  a{color:var(--blue);text-decoration:none}a:hover{text-decoration:underline}
  .cover{width:54px;height:72px;object-fit:cover;border:1px solid var(--line);border-radius:6px;background:#fff}
  .idx{color:#9ca3af;width:56px}
  .pager{display:flex;gap:12px;align-items:center;justify-content:center;margin:16px 0}
  .pager a,.pager span{color:var(--blue);text-decoration:none}.pager .cur{color:#000;font-weight:700}
  .sortable{cursor:pointer;user-select:none}.sortable .arrow{margin-left:6px;color:#9ca3af;font-size:12px}
  .sortable.active{color:#111827}.sortable.active .arrow{color:#2563eb}
  .err{margin:8px 0;padding:10px 12px;border:1px solid #fecaca;background:#fff1f2;color:#991b1b;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>新進館藏</h1>

  <div class="bar">
    <div class="stat" id="stat">顯示第 0 至 0 項結果，共 0 項</div>
    <label><input type="checkbox" id="chkCover" checked> 顯示書影</label>
    <label>每頁
      <select id="selSize"><option>10</option><option selected>20</option><option>50</option></select> 筆
    </label>
    <input id="q" type="text" placeholder="搜尋：題名／索書號" />
    <select id="selLoc"><option value="">全部館藏地</option></select>
  </div>

  <div id="error" class="err" style="display:none"></div>

  <div class="pager" id="topPager"></div>

  <div class="table">
    <table>
      <thead>
        <tr>
          <th class="idx">#</th>
          <th id="thCover" style="width:70px;">書影</th>
          <th>題名</th>
          <th style="width:220px">館藏地</th>
          <th style="width:180px">索書號</th>
          <th style="width:120px" id="thDate" class="sortable">上架日期 <span class="arrow" id="dateArrow">⇅</span></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="pager" id="pager"></div>
</div>

<script>
(() => {
  // 1) 與 index.html 同資料夾的 newbooks.json
  // 若你放到自己的網域，改成完整 URL
  const API = './newbooks.json';

  const state = { page:1, size:20, q:'', loc:'', cover:true, sortDir:'' };
  let RAW = [];

  // ====== Dom ======
  const elTbody = document.getElementById('tbody');
  const elPager = document.getElementById('pager');
  const elTopPager = document.getElementById('topPager');
  const elStat  = document.getElementById('stat');
  const elSize  = document.getElementById('selSize');
  const elQ     = document.getElementById('q');
  const elLoc   = document.getElementById('selLoc');
  const elChkCover = document.getElementById('chkCover');
  const elThCover = document.getElementById('thCover');
  const elThDate  = document.getElementById('thDate');
  const elDateArrow = document.getElementById('dateArrow');
  const elError = document.getElementById('error');

  // ====== 工具 ======
  function showError(msg, detail){
    elError.style.display = '';
    elError.textContent = msg;
    if (detail) console.error('[newbooks] ', detail);
  }
  function paginate(total,page,size){
    const pages = Math.max(1, Math.ceil(total/size));
    page = Math.min(Math.max(1,page), pages);
    return {pages,page,start:(page-1)*size,end:Math.min(page*size,total)};
  }
  function pagerHTML(p,pages){
    const parts=[];
    const add=(t,to,cur)=>{parts.push(cur?`<span class="cur">${t}</span>`:`<a href="#" data-p="${to}">${t}</a>`);};
    if(p>1) add('上一頁',p-1);
    const w=2,l=Math.max(1,p-w),r=Math.min(pages,p+w);
    add(1,1,p===1);
    if(l>2) parts.push('<span>…</span>');
    for(let i=l;i<=r;i++){if(i!==1&&i!==pages) add(i,i,p===i);}
    if(r<pages-1) parts.push('<span>…</span>');
    if(pages>1) add(pages,pages,p===pages);
    if(p<pages) add('下一頁',p+1);
    return parts.join(' ');
  }
  function dateKey(s){
    if(!s) return -Infinity;
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? +(m[1]+m[2]+m[3]) : -Infinity;
  }
  function updateDateHeader(){
    elThDate.classList.toggle('active', !!state.sortDir);
    elDateArrow.textContent = state.sortDir==='asc' ? '▲' : state.sortDir==='desc' ? '▼' : '⇅';
  }

  // ====== 封面候補：Primo → Google → OpenLibrary，全部經代理 ======
  function viaProxy(u){
    if(!u) return '';
    const clean = String(u).replace(/^https?:\/\//,'');
    return `https://images.weserv.nl/?url=${encodeURIComponent(clean)}`;
  }
  const PRIMO_HOST = 'https://uco-scu.primo.exlibrisgroup.com';
  const VID = '886UCO_SCU:886SCU_INST';
  function extractDocId(link){
    const s = String(link || '');
    try{
      const u = new URL(s);
      const raw = u.searchParams.get('docid') || '';
      const d = decodeURIComponent(raw);
      const m = d.match(/alma(\d+)/i) || d.match(/(\d{9,})/);
      return m ? m[1] : '';
    }catch{
      const m = s.match(/[?&]docid=([^&]+)/i);
      if(m){
        const d = decodeURIComponent(m[1]);
        const m1 = d.match(/alma(\d+)/i) || d.match(/(\d{9,})/);
        return m1 ? m1[1] : '';
      }
      return '';
    }
  }
  function primoThumbs(mms){
    if(!mms) return [];
    return [
      `${PRIMO_HOST}/discovery/thumbnail?docid=alma${mms}&vid=${VID}`,
      `${PRIMO_HOST}/discovery/thumbnail?vid=${VID}&docid=alma${mms}`,
      `${PRIMO_HOST}/discovery/thumbnail?docid=alma${mms}&vid=${VID}&context=L`,
      `${PRIMO_HOST}/discovery/thumbnail?docid=alma${mms}&vid=${VID}&context=L&lang=zh-tw`,
    ];
  }
  function googleByIsbn(isbn){
    if(!isbn) return [];
    return [
      // +++ 修正：移除 zoom=2，只保留 zoom=1 +++
      `https://books.google.com/books/content?vid=ISBN:${isbn}&printsec=frontcover&img=1&zoom=1`,
    ];
  }
  function openLibraryByIsbn(isbn){
    if(!isbn) return [];
    return [
      `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg?default=false`,
      `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg?default=false`,
    ];
  }
  function coverCandidates(row){
    const lst=[];
    const mms = extractDocId(row.link);
    
    // +++ 修正：優先嘗試 Google 和 OpenLibrary +++
    if (row.isbn){
      lst.push(...googleByIsbn(row.isbn));
      lst.push(...openLibraryByIsbn(row.isbn));
    }
    
    // +++ Primo 縮圖作為次要備援 +++
    lst.push(...primoThumbs(mms));
    
    if (row.cover) lst.push(row.cover);      // 後端起手式
    const seen=new Set(), out=[];
    for(const u of lst.filter(Boolean)){
      const p = viaProxy(u);
      if(p && !seen.has(p)){ seen.add(p); out.push(p); }
    }
    return out;
  }

  // 占位圖／錯圖 fallback
  const MIN_W = 60, MIN_H = 80;
  const FALLBACK = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="54" height="72"><rect width="100%" height="100%" fill="%23eee"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="10" fill="%23999">No Cover</text></svg>';
  window.__nextCover = function(img){
    const arr = (img.dataset.srcs || '').split('|').filter(Boolean);
    let i = +(img.dataset.idx||0);
    if (i < arr.length - 1){
      img.dataset.idx = i + 1;
      img.src = arr[i + 1];
    } else {
      img.onerror = null; img.onload = null; img.src = FALLBACK;
    }
  };
  window.__checkCover = function(img){
    const w = img.naturalWidth, h = img.naturalHeight;
    if (!w || !h || w < MIN_W || h < MIN_H) window.__nextCover(img);
  };

  // ====== Render ======
  function fillLocations(rows){
    const set=new Set(rows.map(r=>r.location).filter(Boolean));
    elLoc.innerHTML='<option value="">全部館藏地</option>'+[...set].sort().map(x=>`<option>${x}</option>`).join('');
  }
  function render(){
    let rows=RAW.slice();
    const q=elQ.value.trim().toLowerCase();
    if(q) rows=rows.filter(r=>(r.title||'').toLowerCase().includes(q)||(r.callno||'').toLowerCase().includes(q));
    const locVal = elLoc.value;
    if(locVal) rows=rows.filter(r=>r.location===locVal);

    if(state.sortDir){
      rows.sort((a,b)=>{
        const ka=dateKey(a.date), kb=dateKey(b.date);
        return state.sortDir==='asc' ? (ka-kb) : (kb-ka);
      });
    }
    const {pages,page,start,end}=paginate(rows.length,state.page,state.size);
    state.page=page;
    elStat.textContent=`顯示第 ${rows.length?start+1:0} 至 ${end} 項結果，共 ${rows.length} 項`;

    elThCover.style.display=state.cover?'':'none';

    elTbody.innerHTML=rows.slice(start,end).map((r,i)=>{
      const cands = coverCandidates(r);
      const coverHTML = (state.cover && cands.length)
        ? `<img class="cover" src="${cands[0]}" data-srcs="${cands.join('|')}" data-idx="0"
                 loading="lazy" referrerpolicy="no-referrer"
                 onerror="__nextCover(this)" onload="__checkCover(this)" alt="">`
        : (state.cover ? `<img class="cover" src="${FALLBACK}" alt="">` : '');
      return `
      <tr>
        <td class="idx">${start+i+1}</td>
        <td class="coverCol" style="display:${state.cover?'':'none'}">${coverHTML}</td>
        <td><a href="${r.link}" target="_blank" rel="noopener">${r.title}</a></td>
        <td>${r.location||''}</td>
        <td class="nowrap">${r.callno||''}</td>
        <td class="nowrap">${r.date||''}</td>
      </tr>`;
    }).join('');

    const html=pagerHTML(page,pages);
    elPager.innerHTML=html; elTopPager.innerHTML=html;
    [elPager,elTopPager].forEach(p=>{
      p.onclick=e=>{
        const a=e.target.closest('a[data-p]');
        if(a){e.preventDefault();state.page=+a.dataset.p;render();}
      };
    });
    updateDateHeader();
  }

  // ====== 載入 JSON（兼容多種形態） ======
  function tryParseAny(text){
    try{return JSON.parse(text);}catch(e){}
    const s=text.indexOf('{'),e=text.lastIndexOf('}');
    if(s>=0&&e>s){ try{return JSON.parse(text.slice(s,e+1));}catch(e){} }
    const m=text.match(/"rows"\s*:\s*(\[[\s\S]*\])/);
    if(m){ try{return {rows:JSON.parse(m[1])};}catch(e){} }
    return null;
  }
  function extractRows(obj){
    if(!obj) return [];
    if (Array.isArray(obj)) {
      if (obj.length && obj[0] && obj[0].json && Array.isArray(obj[0].json.rows)) return obj[0].json.rows;
      if (Array.isArray(obj)) return obj; // 若純 rows 陣列
    }
    if (obj.rows && Array.isArray(obj.rows)) return obj.rows;
    return [];
  }
  async function load(){
    try{
      const r = await fetch(API,{cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const txt = await r.text();
      const parsed = tryParseAny(txt);
      const rows = extractRows(parsed);
      if (!rows.length) throw new Error('JSON 無 rows');
      RAW = rows;
      fillLocations(RAW);
      render();
    }catch(err){
      showError('載入資料失敗，請確認 newbooks.json 與 index.html 是否在同一資料夾，或 API 路徑是否正確。', err);
    }
  }

  // 事件
  elSize.onchange=()=>{state.size=+elSize.value;state.page=1;render();};
  elQ.oninput=()=>{state.page=1;render();};
  elLoc.onchange=()=>{state.page=1;render();};
  elChkCover.onchange=()=>{state.cover=elChkCover.checked;render();};
  elThDate.onclick=()=>{state.page=1;state.sortDir = state.sortDir==='' ? 'desc' : state.sortDir==='desc' ? 'asc' : '';render();};

  load();
})();
</script>
</body>
</html>