<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>新進館藏</title>
<style>
  :root{
    --fg:#1f2937;--muted:#6b7280;--blue:#2563eb;--line:#e5e7eb;--bg:#fafafa;
    --maxw:1100px;--radius:12px;
  }
  *{box-sizing:border-box}
  html,body{margin:0}
  body{font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
       color:var(--fg);background:var(--bg)}
  .wrap{max-width:var(--maxw);margin:auto;padding:20px}
  h1{margin:10px 0 14px;font-size:24px;font-weight:700}
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:6px 0 14px}
  .stat{color:var(--muted);font-size:13px}
  select,input[type="text"]{height:32px;border:1px solid var(--line);border-radius:8px;padding:0 8px;background:#fff}
  input[type="checkbox"]{transform:translateY(1px)}
  .table{background:#fff;border:1px solid var(--line);border-radius:var(--radius);overflow:hidden}
  table{width:100%;border-collapse:collapse}
  thead th{background:#f8fafc;color:#374151;font-weight:600;font-size:14px}
  th,td{padding:12px 14px;border-bottom:1px solid var(--line);vertical-align:top}
  td.nowrap{white-space:nowrap}
  a{color:var(--blue);text-decoration:none}
  a:hover{text-decoration:underline}
  .cover{width:54px;height:72px;object-fit:cover;border:1px solid var(--line);border-radius:6px;background:#fff}
  .idx{color:#9ca3af;width:56px}
  .pager{display:flex;gap:12px;align-items:center;justify-content:center;margin:16px 0}
  .pager a,.pager span{color:var(--blue);text-decoration:none}
  .pager .cur{color:#000;font-weight:700}
</style>
</head>
<body>
  <div class="wrap">
    <h1>新進館藏</h1>

    <div class="bar">
      <div class="stat" id="stat">顯示第 0 至 0 項結果，共 0 項</div>
      <label><input type="checkbox" id="chkCover"> 顯示書影</label>
      <label>每頁
        <select id="selSize">
          <option>10</option><option selected>20</option><option>50</option>
        </select> 筆
      </label>
      <input id="q" type="text" placeholder="搜尋：題名／索書號" />
      <select id="selLoc"><option value="">全部館藏地</option></select>
    </div>

    <div class="pager" id="topPager"></div>

    <div class="table">
      <table>
        <thead>
          <tr>
            <th class="idx">#</th>
            <th id="thCover" style="width:70px;display:none">書影</th>
            <th>題名</th>
            <th style="width:180px">館藏地</th>
            <th style="width:160px">索書號</th>
            <th style="width:120px">上架日期</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="pager" id="pager"></div>
  </div>

<script>
(() => {
  const API = 'https://scudtlib.github.io/newbooks/newbooks.json';

  const state = { page:1, size:20, q:'', loc:'', cover:false };
  let RAW = [];

  const elTbody = document.getElementById('tbody');
  const elPager = document.getElementById('pager');
  const elTopPager = document.getElementById('topPager');
  const elStat  = document.getElementById('stat');
  const elSize  = document.getElementById('selSize');
  const elQ     = document.getElementById('q');
  const elLoc   = document.getElementById('selLoc');
  const elChkCover = document.getElementById('chkCover');
  const elThCover = document.getElementById('thCover');

  /* -------------- 分頁 -------------- */
  function paginate(total,page,size){
    const pages = Math.max(1, Math.ceil(total/size));
    page = Math.min(Math.max(1,page), pages);
    return {pages,page,start:(page-1)*size,end:Math.min(page*size,total)};
  }

  function pagerHTML(p,pages){
    const parts=[];
    const add=(t,to,cur)=>{parts.push(cur?`<span class="cur">${t}</span>`:`<a href="#" data-p="${to}">${t}</a>`);};
    if(p>1) add('上一頁',p-1);
    const w=2,l=Math.max(1,p-w),r=Math.min(pages,p+w);
    add(1,1,p===1);
    if(l>2) parts.push('<span>…</span>');
    for(let i=l;i<=r;i++){if(i!==1&&i!==pages) add(i,i,p===i);}
    if(r<pages-1) parts.push('<span>…</span>');
    if(pages>1) add(pages,pages,p===pages);
    if(p<pages) add('下一頁',p+1);
    return parts.join(' ');
  }

  /* -------------- 館藏地 -------------- */
  function fillLocations(rows){
    const set=new Set(rows.map(r=>r.location).filter(Boolean));
    elLoc.innerHTML='<option value="">全部館藏地</option>'+[...set].sort().map(x=>`<option>${x}</option>`).join('');
  }

  /* -------------- 書影：來源串接與失敗接力 -------------- */
  const PRIMO_HOST = 'https://uco-scu.primo.exlibrisgroup.com';
  const VID = '886UCO_SCU:886SCU_INST';

  // 從 fulldisplay 連結解析 MMSID（docid=almaXXXXXXXXXXXXX）
  function getMMS(link){
    const m = (link||'').match(/docid=alma(\d+)/i);
    return m ? m[1] : '';
  }

  // 依序組書影候選清單：OpenLibrary(資料內的 r.cover) → Primo thumbnail
  function coverCandidates(r){
    const list = [];
    if (r.cover) list.push(r.cover);
    const mms = getMMS(r.link);
    if (mms) {
      // Primo VE 官方縮圖端點
      list.push(`${PRIMO_HOST}/discovery/thumbnail?docid=alma${mms}&vid=${VID}`);
    }
    return list;
  }

  // <img> onerror：換下一個來源，全部失敗則隱藏
  window.__nextCover = function(img){
    const arr = (img.dataset.srcs || '').split('|').filter(Boolean);
    let i = +(img.dataset.idx||0);
    if (i < arr.length - 1){
      img.dataset.idx = i + 1;
      img.src = arr[i + 1];
    }else{
      img.style.display = 'none';
    }
  };

  /* -------------- 繪製 -------------- */
  function render(){
    let rows=RAW;
    const q=state.q.trim().toLowerCase();
    if(q) rows=rows.filter(r=>(r.title||'').toLowerCase().includes(q)||(r.callno||'').toLowerCase().includes(q));
    if(state.loc) rows=rows.filter(r=>r.location===state.loc);

    const {pages,page,start,end}=paginate(rows.length,state.page,state.size);
    state.page=page;
    elStat.textContent=`顯示第 ${rows.length?start+1:0} 至 ${end} 項結果，共 ${rows.length} 項`;

    elThCover.style.display=state.cover?'':'none';

    elTbody.innerHTML=rows.slice(start,end).map((r,i)=>{
      const cands = coverCandidates(r);
      const coverHTML = (state.cover && cands.length)
        ? `<img class="cover" src="${cands[0]}" data-srcs="${cands.join('|')}" data-idx="0" onerror="__nextCover(this)" alt="">`
        : '';
      return `
      <tr>
        <td class="idx">${start+i+1}</td>
        <td class="coverCol" style="display:${state.cover?'':'none'}">${coverHTML}</td>
        <td><a href="${r.link}" target="_blank">${r.title}</a></td>
        <td>${r.location||''}</td>
        <td class="nowrap">${r.callno||''}</td>
        <td class="nowrap">${r.date||''}</td>
      </tr>`;
    }).join('');

    const html=pagerHTML(page,pages);
    elPager.innerHTML=html;
    elTopPager.innerHTML=html;
    [elPager,elTopPager].forEach(p=>{
      p.onclick=e=>{
        const a=e.target.closest('a[data-p]');
        if(a){e.preventDefault();state.page=+a.dataset.p;render();}
      };
    });
  }

  /* -------------- 載入 -------------- */
  function tryParseAny(text){
    try{return JSON.parse(text);}catch(e){}
    const s=text.indexOf('{'),e=text.lastIndexOf('}');
    if(s>=0&&e>s) try{return JSON.parse(text.slice(s,e+1));}catch(_){}
    const m=text.match(/"rows"\s*:\s*(\[[\s\S]*\])/);
    if(m) try{return {rows:JSON.parse(m[1])};}catch(_){}
    return null;
  }

  async function load(){
    try{
      const r=await fetch(API,{cache:'no-store'});
      const txt=await r.text();
      let d=tryParseAny(txt);
      if(!d) throw new Error("無法解析 JSON");
      if(Array.isArray(d)) d=d[0]||{};
      RAW=d.rows||[];
      fillLocations(RAW);
      render();
    }catch(e){alert('載入資料失敗：'+e.message);}
  }

  /* -------------- 事件 -------------- */
  elSize.onchange=()=>{state.size=+elSize.value;state.page=1;render();};
  elQ.oninput=()=>{state.q=elQ.value;state.page=1;render();};
  elLoc.onchange=()=>{state.loc=elLoc.value;state.page=1;render();};
  elChkCover.onchange=()=>{state.cover=elChkCover.checked;render();};

  load();
})();
</script>
</body>
</html>
