<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>新進館藏</title>
  <style>
    :root{
      --fg:#222;
      --fg-soft:#666;
      --border:#ddd;
      --link:#06c;
      --link-hover:#039;
      --bg:#fff;
      --muted:#f9f9f9;
    }
    html,body{background:var(--bg); color:var(--fg);}
    body{
      font-family:"Microsoft JhengHei","Segoe UI",Roboto,Arial,sans-serif;
      font-size:15px; line-height:1.6; margin:40px;
    }
    h1{
      margin:0 0 12px;
      font-size:24px; font-weight:700; letter-spacing:.02em;
    }

    /* 工具列 */
    .toolbar{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      justify-content:flex-end; margin:4px 0 8px;
    }
    .toolbar .stat{
      margin-right:auto; color:var(--fg-soft); font-size:13px;
    }
    select,input,label{ font-size:14px; }
    select,input{
      padding:3px 6px; border:1px solid var(--border); border-radius:8px;
      background:#fff;
    }
    .check{
      display:inline-flex; align-items:center; gap:6px; user-select:none;
      color:var(--fg-soft);
    }

    /* 表格 */
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{
      border-bottom:1px solid var(--border);
      padding:6px 10px; vertical-align:top; text-align:left;
    }
    th{ background:var(--muted); font-weight:600; }
    a{ color:var(--link); text-decoration:none; }
    a:hover{ color:var(--link-hover); text-decoration:underline; }

    /* 書影欄 */
    .col-cover{ width:64px; }
    .cover{
      width:56px; height:76px; object-fit:cover; border:1px solid var(--border);
      background:#fff; border-radius:4px; display:block;
    }
    /* 當「顯示書影」關閉時，整欄隱藏 */
    .hide-cover .col-cover,
    .hide-cover td.col-cover { display:none; }

    /* 分頁 */
    .pager{
      display:flex; justify-content:center; align-items:center;
      gap:10px; margin:16px 0; flex-wrap:wrap;
      color:var(--fg-soft);
    }
    .pager a,.pager button{
      border:none; background:transparent; color:var(--link);
      cursor:pointer; font-size:15px; padding:0 2px;
    }
    .pager a:hover,.pager button:hover{ color:var(--link-hover); text-decoration:underline; }
    .pager .current{ color:var(--fg); font-weight:700; }
    .pager .disabled{ color:#aaa; pointer-events:none; text-decoration:none; }

    /* 上架日期不換行 */
    .nowrap{ white-space:nowrap; }
  </style>
</head>
<body class="hide-cover"><!-- 預設不顯示書影：套用 hide-cover -->

  <h1>新進館藏</h1>

  <!-- 上方工具列 -->
  <div class="toolbar topbar">
    <span class="stat" id="stat-top"></span>

    <label class="check">
      <input type="checkbox" id="showCovers">
      顯示書影（ISBN 封面）
    </label>

    <label>每頁
      <select id="pageSize">
        <option>10</option>
        <option selected>20</option>
        <option>50</option>
      </select> 筆
    </label>

    <input id="searchBox" placeholder="搜尋：題名／索書號" style="min-width:280px;">
    <select id="locFilter">
      <option value="">全部館藏地</option>
    </select>
  </div>

  <!-- 上方分頁 -->
  <div class="pager" id="pager-top"></div>

  <table>
    <thead>
      <tr>
        <th style="width:48px">#</th>
        <th class="col-cover">書影</th>
        <th>題名</th>
        <th style="width:160px">館藏地</th>
        <th style="width:160px">索書號</th>
        <th style="width:120px">上架日期</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>

  <div class="toolbar bottombar">
    <span class="stat" id="stat-bottom"></span>
  </div>

  <!-- 下方分頁 -->
  <div class="pager" id="pager"></div>

<script>
const API = 'https://sculib.app.n8n.cloud/webhook/sculibnewbooks';

let RAW = [];
let state = { page:1, size:20, q:"", loc:"", showCover:false };

async function load(){
  try{
    const r = await fetch(API, { cache:'no-store' });
    const d = await r.json();
    RAW = Array.isArray(d.rows) ? d.rows : [];
    render();
    fillLocations();
  }catch(e){
    alert('載入新進館藏失敗：'+ e.message);
  }
}

function fillLocations(){
  const sel = document.getElementById('locFilter');
  const locs = [...new Set(RAW.map(r=>r.location).filter(Boolean))].sort();
  for(const l of locs){
    const opt=document.createElement('option');
    opt.value=opt.textContent=l;
    sel.appendChild(opt);
  }
}

function buildPager(containerId, page, pages){
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  if(pages<=1) return;

  const push = (html, on, cls) => {
    const a = document.createElement(on?'a':'span');
    a.innerHTML = html;
    if(cls) a.className = cls;
    if(on) a.href='javascript:;';
    el.appendChild(a);
    return a;
  };

  const go = p => { state.page=p; render(); window.scrollTo(0,0); };

  // 上一頁
  const prev = push('上一頁', page>1);
  if(prev) prev.onclick=()=>go(page-1);

  // 中間數字：1 ... p-2 p-1 p p+1 p+2 ... last
  const pagesArr = [];
  for(let i=1;i<=pages;i++){
    if(i===1 || i===pages || Math.abs(i-page)<=2){
      pagesArr.push(i);
    }else if(pagesArr[pagesArr.length-1] !== '...'){
      pagesArr.push('...');
    }
  }

  pagesArr.forEach(n=>{
    if(n==='...'){ push('...', false, 'disabled'); }
    else if(n===page){ push(String(n), false, 'current'); }
    else{
      const a = push(String(n), true);
      a.onclick = ()=>go(n);
    }
  });

  // 下一頁
  const next = push('下一頁', page<pages);
  if(next) next.onclick=()=>go(page+1);
}

function render(){
  const { page, size, q, loc, showCover } = state;
  const qlow = q.trim().toLowerCase();

  let rows = RAW.filter(r=>{
    const hit = !q || r.title.toLowerCase().includes(qlow) || r.callno.toLowerCase().includes(qlow);
    const lhit = !loc || r.location === loc;
    return hit && lhit;
  });

  const total = rows.length;
  const pages = Math.max(1, Math.ceil(total / size));
  if(state.page>pages) state.page = pages;

  const start = (state.page - 1) * size;
  const end   = Math.min(start + size, total);
  const pageRows = rows.slice(start, end);

  // 切換 body class 以隱藏/顯示 書影欄
  document.body.classList.toggle('hide-cover', !showCover);

  // render rows
  const tb = document.getElementById('list');
  tb.innerHTML = '';
  pageRows.forEach((r, i) => {
    const tr = document.createElement('tr');
    const idx = start + i + 1;

    tr.innerHTML = `
      <td>${idx}</td>
      <td class="col-cover">
        ${r.cover ? `<img class="cover" src="${r.cover}" onerror="this.style.display='none'">` : ''}
      </td>
      <td><a href="${r.link}" target="_blank" rel="noopener">${r.title}</a></td>
      <td>${r.location || ''}</td>
      <td>${r.callno || ''}</td>
      <td class="nowrap">${r.date || ''}</td>
    `;
    tb.appendChild(tr);
  });

  // stat
  const statTxt = total
    ? `顯示第 ${total? (start+1):0} 至 ${end} 項結果，共 ${total} 項`
    : `沒有符合條件的資料`;
  document.getElementById('stat-top').textContent = statTxt;
  document.getElementById('stat-bottom').textContent = statTxt;

  // pagers
  buildPager('pager-top', state.page, pages);
  buildPager('pager', state.page, pages);
}

/* 綁定事件 */
document.getElementById('pageSize').onchange = e => { state.size = +e.target.value; state.page = 1; render(); };
document.getElementById('searchBox').oninput = e => { state.q = e.target.value; state.page = 1; render(); };
document.getElementById('locFilter').onchange = e => { state.loc = e.target.value; state.page = 1; render(); };
document.getElementById('showCovers').onchange = e => { state.showCover = e.target.checked; render(); };

load();
</script>
</body>
</html>
