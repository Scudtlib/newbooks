<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>新進館藏</title>
<style>
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:24px}
h1{font-size:20px;margin:0 0 16px}
.toolbar{display:flex;gap:12px;align-items:center;margin:0 0 12px;flex-wrap:wrap}
.toolbar input,.toolbar select{padding:8px;border:1px solid #ddd;border-radius:8px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:10px 8px;vertical-align:top}
th{background:#fafafa;position:sticky;top:0}
.thumb{width:54px;height:72px;object-fit:cover;border:1px solid #eee;border-radius:4px;background:#fff}
.title { line-height:1.3; }          /* 控制題名行高 */
.title a { 
  color:#0b57d0;
  text-decoration:none;
  font-size:15px; 
  display:block;
  margin-bottom:2px;                /* 題名與日期間距 */
}
.title a:hover { text-decoration:underline }
.meta {
  color:#666;
  font-size:12px;
  margin:0;
}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px}
.pager button{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
.pager button[disabled]{opacity:.4;cursor:not-allowed}
.empty{padding:24px;color:#666}
@media(max-width:720px){ th:nth-child(4),td:nth-child(4){display:none} } /* 手機隱藏索書號 */
</style>
</head>
<body>
<h1>新進館藏</h1>

<div class="toolbar">
  <label>每頁
    <select id="pageSize"><option>10</option><option>20</option><option>50</option></select> 筆
  </label>
  <input id="q" placeholder="關鍵字搜尋（題名／作者／索書號）"/>
  <select id="loc"><option value="">全部館藏地</option></select>
</div>

<table id="tbl">
  <thead>
    <tr>
      <th style="width:60px;">書影</th>
      <th>題名</th>
      <th style="width:160px;">館藏地</th>
      <th style="width:160px;">索書號</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="pager">
  <button id="prev">上一頁</button>
  <span id="info"></span>
  <button id="next">下一頁</button>
</div>

<script>
const API = 'https://sculib.app.n8n.cloud/webhook/sculibnewbooks';
let RAW = [];
const state = { page:1, size:10, q:"", loc:"" };

const qEl = document.getElementById('q');
const sizeEl = document.getElementById('pageSize');
const locEl = document.getElementById('loc');
const tbody = document.querySelector('#tbl tbody');
const prev = document.getElementById('prev');
const next = document.getElementById('next');
const info = document.getElementById('info');

function fillLocations(){
  const set = new Set(RAW.map(r=>r.location).filter(Boolean));
  locEl.innerHTML = '<option value="">全部館藏地</option>' +
    [...set].sort().map(v=>`<option>${v}</option>`).join('');
}

function applyFilter(){
  const q = state.q.trim().toLowerCase();
  return RAW.filter(r=>{
    if(state.loc && r.location!==state.loc) return false;
    if(!q) return true;
    const hay = (r.title+' '+r.authorYear+' '+r.callno).toLowerCase();
    return hay.includes(q);
  });
}

function render(){
  const rows = applyFilter();
  const total = rows.length;
  const pages = Math.max(1, Math.ceil(total/state.size));
  if(state.page>pages) state.page = pages;
  const start = (state.page-1)*state.size;
  const pageRows = rows.slice(start, start+state.size);

  if(pageRows.length===0){
    tbody.innerHTML = `<tr><td class="empty" colspan="4">目前沒有資料</td></tr>`;
  }else{
    tbody.innerHTML = pageRows.map(r=>`
      <tr>
        <td><img class="thumb" src="${r.cover}" onerror="this.style.visibility='hidden'"/></td>
        <td class="title">
          <a href="${r.link||'#'}" target="_blank" rel="noopener">${r.title||'(無題名)'}</a>
          <div class="meta">${r.authorYear||''}</div>
        </td>
        <td>${r.location||''}</td>
        <td>${r.callno||''}</td>
      </tr>`).join('');
  }

  info.textContent = total ? `第 ${start+1}-${Math.min(start+state.size,total)} 筆，共 ${total} 筆` : '';
  prev.disabled = state.page<=1;
  next.disabled = state.page>=pages;
}

qEl.addEventListener('input', ()=>{ state.q=qEl.value; state.page=1; render(); });
sizeEl.addEventListener('change', ()=>{ state.size=+sizeEl.value; state.page=1; render(); });
locEl.addEventListener('change', ()=>{ state.loc=locEl.value; state.page=1; render(); });
prev.addEventListener('click', ()=>{ if(state.page>1){ state.page--; render(); }});
next.addEventListener('click', ()=>{ state.page++; render(); });

async function load(){
  try{
    const r = await fetch(API, { cache:'no-store' });
    const d = await r.json();
    RAW = Array.isArray(d.rows) ? d.rows : [];
    if (!RAW.length) throw new Error('no rows');
  }catch(e){
    alert('載入新進館藏失敗：' + e.message);
    RAW = [];
  }
  fillLocations();
  render();
}
load();
</script>
</body>
</html>